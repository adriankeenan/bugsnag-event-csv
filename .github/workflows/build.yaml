name: Test & Publish

on:
    push:

jobs:

    app-test:
        runs-on: ubuntu-latest
        strategy:
            fail-fast: false
            matrix:
                php_version:
                    - '8.1'
                    - '8.2'
        steps:
            - name: Checkout
              uses: actions/checkout@v3

            - name: Setup PHP
              uses: shivammathur/setup-php@v2
              with:
                  php-version: ${{ matrix.php_version }}

            - name: Install dependencies
              run: composer install

            - name: Run tests
              run: composer test

    docker-test:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v3

            - name: Build image
              run: docker build -t bugsnag-event-csv .

            - name: Check image output
              run: docker run bugsnag-event-csv --help | grep "Options:"

    docker-publish:
        if: github.ref == 'refs/heads/master'
        runs-on: ubuntu-latest
        needs:
          - app-test
          - docker-test
        steps:
            - name: Check out the repo
              uses: actions/checkout@v3

            - name: Login to DockerHub
              uses: docker/login-action@v1 
              with:
                  username: ${{ secrets.DOCKERHUB_USERNAME }}
                  password: ${{ secrets.DOCKERHUB_TOKEN }}

            - name: Build and push
              id: docker_build
              uses: docker/build-push-action@v2
              with:
                  push: true
                  tags: adriankeenan/bugsnag-event-csv:latest
